# Identity Service

Author(s): Niels de Vos

This document and the Identity Service is based on the [Container Storage
Interface specification][csi_spec].

## Terminology

| Term       | Definition                                                                               |
| ---------- | ---------------------------------------------------------------------------------------- |
| CSI        | [Container Storage Interface][csi_spec].                                                 |
| CSI-driver | A component that implements CSI service RPCs, the CSI Controller or NodePlugin.          |
| CO         | Container Orchestration system that communicates with users and CSI-Addons service RPCs. |
| SP         | Storage Provider, the vendor of a CSI-driver implementation.                             |
| RPC        | [Remote Procedure Call](https://en.wikipedia.org/wiki/Remote_procedure_call).            |

## Objective

Define an API that makes it possible for the CSI-Addons Controller(s) to
communicate with the CSI-Addons side-cars that are running with the CSI-driver
components.

### Goals in MVP

The API will

* make it possible for worker nodes (CSI-Addons side-car) to announce
  themselves
* have the CSI-Addons Controller list all announced CSI-Addons side-cars and
  CSI-drivers
* provide details about CSI-Addons features the CSI-driver supports

### Non-Goals in MVP

This will be limited to node discovery functionality only. CSI-Addons features
will be documented in their own specifications. The available capabilities will
get extended when new CSI-Addons operations are proposed.

## Solution Overview

CSI-Addons side-cars for the CSI-Controller and CSI-NodePlugins will announce
themselves at the CO.

The CSI-Addons Controller reacts on events generated by the CO (e.g. Kubernetes
CRDs) that trigger actions. When a CSI-Addons Node is announced to the CO, the
CSI-Addons Controller will connect to the Node and request the available
capabilities.

The CSI-Addons side-cars communicate over a UNIX-Domain-Socket with the
CSI-drivers (CSI Controller and NodePlugin).

## Architecture

A user (someone that creates/consumes CSI volumes) instructs the CSI-Addons
Controller to invoke a storage maintenance operation. This interaction is done
in a CO specific way (e.g. a Custom Resourse will be provided for Kubernetes).

The CSI-Addons Controller inspects the instruction from the user, and formats
it into an operation that is sent to one or more CSI-Addons side-cars. The
side-cars eventually invoke the operation at the CSI-driver.

```text
.------.       .------------.
| User |-------| CSI-Addons |
'------'       | Controller |
               '------------'
                      |
                      | gRPC
                      |
            .---------+------------------------------.
            |         |                              |
            |  .------------.        .------------.  |
            |  | CSI-Addons |  gRPC  |    CSI     |  |
            |  |  side-car  |--------| Controller |  |
            |  '------------'        | NodePlugin |  |
            |                        '------------'  |
            | CSI-driver Pod                         |
            '----------------------------------------'
```

## RPC Interface

* **Identity Service**: The Node **MUST** implement this, the Controller uses
  the Identity Service to inspect the capabilities of the Node and CSI-driver.

```protobuf
syntax = "proto3";
package identity;

import "google/protobuf/wrappers.proto"; // for BoolValue in ProbeResponse

option go_package = ".;identity";

// Identity is the service that CSI-drivers MUST implement in order to be
// compatible with CSI-Addons specification. It provides the basic details that
// are needed by the CSI-Addons Controller to communicate with the CSI-driver
// and detects its supported features.
service Identidy {
  // GetIdentity returns basic information about the side-car and CSI-driver.
  rpc GetIdentity(GetIdentityRequest)
  returns (GetIdentityResponse) {}

  // GetCapabilities returns the capabilities that the CSI-Addons side-car and
  // CSI-driver support.
  rpc GetCapabilities(GetCapabilitiesRequest)
  returns (GetCapabilitiesResponse) {}

  // Probe is called by the Controller to validate that the CSI-Addons Node is
  // still healthy.
  rpc Probe(ProbeRequest)
  returns (ProbeResponse) {}
}
```

### `GetIdentity`

The CSI-driver needs to provide its driver-name so that the CSI-Addons
Controller can invoke RPCs for volumes that use this driver. There is an option
for the CSI-driver to provide details about its version and a key/value
manifest.

```protobuf
// GetIdentityRequest is sent by the CSI-Addons Controller to obtain the
// drivername, version and optional details from the CSI-driver.
message GetIdentityRequest {
  // Intentionally empty.
}

// GetIdentityResponse is returned by the CSI-driver as a response to a
// GetIdentityRequest.
message GetIdentityResponse {
  // The name MUST follow domain name notation format
  // (https://tools.ietf.org/html/rfc1035#section-2.3.1). It SHOULD include
  // the CSI-drivers's host company name and the CSI-driver name, to minimize
  // the possibility of collisions. It MUST be 63 characters or less, beginning
  // and ending with an alphanumeric character ([a-z0-9A-Z]) with dashes (-),
  // dots (.), and alphanumerics between. This field is REQUIRED.
  string name = 1;
  // This field is REQUIRED. Value of this field is opaque to the CO.
  string vendor_version = 2;
  // This field is OPTIONAL. Values are opaque to the CO.
  map<string, string> manifest = 3;
}
```

#### GetIdentity Errors

If the CSI-driver is unable to complete the GetIdentity call successfully, it
MUST return a non-ok gRPC code in the gRPC status.

### `GetCapabilities`

The CSI-Addons Controller needs to detect the supported features for each
CSI-driver. Features are described as capabilities, each with additional
information on how the CSI-Addons Controller may invoke the operation.

There might be operations that need to run on the CSI Controller (provisioner)
for storage system access. Other operations may require running on a volume
that is attached/staged on a node. By specifying the type of Service that the
CSI-driver provides, the CSI-Addons Controller can make informed decisions on
where to invoke the RPCs for an operation.

```protobuf
// GetCapabilitiesRequest is sent by the CSI-Addons Controller to detect the
// features that a CSI-driver supports.
message GetCapabilitiesRequest {
  // Intentionally empty.
}

// GetCapabilitiesResponse is returned by the CSI-driver as a response to a
// GetCapabilitiesRequest.
message GetCapabilitiesResponse {
  // All the capabilities that the controller service supports. This
  // field is OPTIONAL.
  repeated Capability capabilities = 1;
}

// Specifies one or more capabilities of the CSI-driver.
message Capability {
  // Service contains the type of CSI Service that the CSI-driver provides.
  message Service {
    // Type describes a CSI Service that CSI-drivers can support.
    enum Type {
      // UNKNOWN indicates that the CSI-driver does not neither provide the CSI
      // ControllerService or CSI NodeService. The CSI-Addons Controller will
      // most likely ignore the node providing this Identify Service.
      UNKNOWN = 0;

      // CONTROLLER_SERVICE indicates that the CSI-driver provides RPCs for the
      // CSI ControllerService.
      // The presence of this capability determines whether the CSI-Addons
      // Controller can invoke RPCs that require access to the storage system,
      // similar to the CSI Controller (provisioner).
      CONTROLLER_SERVICE = 1;

      // NODE_SERVICE indicates that the CSI-driver provides RPCs for the CSI
      // NodeService.
      // The presence of this capability determines whether the CSI-Addons
      // Controller can invoke RPCs that require a volume to be staged/attached
      // to the node.
      NODE_SERVICE = 2;
    }
    // type contains the Type of CSI Service that the CSI-driver supports.
    Type type = 1;
  }

  //message ReclaimSpace {
  //
  // example included for ReclaimSpace support
  //
  //}

  oneof type {
    // Service or operation that the CSI-driver supports.
    Service service = 1;
    //ReclaimSpace reclaim_space = 2;
  }
}
```

#### GetCapabilities Errors

If the CSI-driver is unable to complete the GetCapabilities call successfully,
it MUST return a non-ok gRPC code in the gRPC status.

### `Probe`

The primary utility of the Probe RPC is to verify that the CSI-driver is in a
healthy and ready state. If an unhealthy state is reported, via a non-success
response, a CSI-Addons Controller MAY take action with the intent to bring the
CSI-driver to a healthy state. Such actions MAY include, but SHALL NOT be
limited to, the following:

* Restarting the CSI-driver container, or
* Notifying the CSI-driver supervisor.

The CSI-driver MAY verify that it has the right configurations, devices,
dependencies and drivers in order to run and return a success if the validation
succeeds.
The CSI-Addons Controller MAY invoke this RPC at any time.
The CSI-Addons Controller MAY invoke this call multiple times with the
understanding that a CSI-driver's implementation MAY NOT be trivial and there
MAY be overhead incurred by such repeated calls.
The SP SHALL document guidance and known limitations regarding a particular
CSI-driver's implementation of this RPC.
For example, the SP MAY document the maximum frequency at which its Probe
implementation SHOULD be called.

```protobuf
// ProbeRequest is sent to the CSI-driver to confirm that it can respond to
// requests from the CSI-Adons Controller.
message ProbeRequest {
  // Intentionally empty.
}

// ProbeResponse is returned by the CSI-driver as a response to a ProbeRequest.
message ProbeResponse {
  // Readiness allows a CSI-driver to report its initialization status back
  // to the CSI-Addons Controller. Initialization for some CSI-drivers MAY be
  // time consuming and it is important for a CO to distinguish between the
  // following cases:
  //
  // 1) The CSI-driver is in an unhealthy state and MAY need restarting. In
  //    this case a gRPC error code SHALL be returned.
  // 2) The CSI-driver is still initializing, but is otherwise perfectly
  //    healthy. In this case a successful response SHALL be returned
  //    with a readiness value of `false`. Calls to the CSI-driver's
  //    Controller and/or Node services MAY fail due to an incomplete
  //    initialization state.
  // 3) The CSI-driver has finished initializing and is ready to service
  //    calls to its Controller and/or Node services. A successful
  //    response is returned with a readiness value of `true`.
  //
  // This field is OPTIONAL. If not present, the caller SHALL assume
  // that the CSI-driver is in a ready state and is accepting calls to its
  // Controller and/or Node services (according to the CSI-driver's reported
  // capabilities).
  .google.protobuf.BoolValue ready = 1;
}
```

#### Probe Errors

If the CSI-driver is unable to complete the Probe call successfully, it MUST
return a non-ok gRPC code in the gRPC status.

If the conditions defined below are encountered, the CSI-driver MUST return the
specified gRPC error code.

The CSI-Addons Controller MAY implement the specified error recovery behavior
when it encounters the gRPC error code.

| Condition | gRPC Code | Description | Recovery Behavior |
|-----------|-----------|-------------|-------------------|
| CSI-driver not healthy | 9 FAILED_PRECONDITION | Indicates that the CSI-driver is not in a healthy/ready state. | Caller SHOULD assume the CSI-driver is not healthy and that future RPCs MAY fail because of this condition. |
| Missing required dependency | 9 FAILED_PRECONDITION | Indicates that the CSI-driver is missing one or more required dependency. | Caller MUST assume the CSI-driver is not healthy. |

[csi_spec]: https://github.com/container-storage-interface/spec/blob/master/spec.md
